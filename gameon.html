<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogo Online com Supabase</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    #gameArea {
      width: 90vw;
      height: 90vw;
      max-width: 500px;
      max-height: 500px;
      border: 2px solid black;
      position: relative;
      background-color: #fff;
    }
    .player {
      width: 6%;
      height: 6%;
      position: absolute;
      border-radius: 50%;
    }
    .player-current {
      background-color: red;
    }
    .player-other {
      background-color: blue;
    }
    .controls {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      width: 90vw;
      max-width: 500px;
    }
    .button {
      width: 60px;
      height: 60px;
      background-color: #333;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      user-select: none;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="player1" class="player player-current"></div>
  </div>
  
  <div class="controls">
    <div class="button" id="up">⬆️</div>
    <div class="button" id="left">⬅️</div>
    <div class="button" id="down">⬇️</div>
    <div class="button" id="right">➡️</div>
  </div>

  <!-- Supabase JS library -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.0.0"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const SUPABASE_URL = 'https://jkcdogakjwcpezuaqgki.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprY2RvZ2FrandjcGV6dWFxZ2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2ODc2OTksImV4cCI6MjA0NjI2MzY5OX0.MxzcUE3s8Cyty6Y8IP4O-1Tzx57RVnZi1VDNSixswQE';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const playerElement = document.getElementById('player1');
      const playerId = Math.floor(Math.random() * 1000); // ID único para cada jogador
      let posX = 45;
      let posY = 45;

      console.log("Jogador ID:", playerId);

      // Função para atualizar a posição do jogador no Supabase
      async function updatePlayerPosition(x, y) {
        const { data, error } = await supabase
          .from('game_state')
          .upsert({ player_id: playerId, position_x: x, position_y: y, last_updated: new Date() });

        if (error) {
          console.error("Erro ao atualizar posição:", error);
        } else {
          console.log("Posição atualizada:", data);
        }
      }

      // Inicializa a posição do jogador no centro do gameArea
      playerElement.style.left = `${posX}%`;
      playerElement.style.top = `${posY}%`;
      updatePlayerPosition(posX, posY);

      // Funções de movimento
      function moveUp() { posY = Math.max(0, posY - 5); updatePosition(); }
      function moveDown() { posY = Math.min(94, posY + 5); updatePosition(); }
      function moveLeft() { posX = Math.max(0, posX - 5); updatePosition(); }
      function moveRight() { posX = Math.min(94, posX + 5); updatePosition(); }

      function updatePosition() {
        playerElement.style.left = `${posX}%`;
        playerElement.style.top = `${posY}%`;
        updatePlayerPosition(posX, posY);
      }

      // Controles de toque
      document.getElementById('up').addEventListener('click', moveUp);
      document.getElementById('down').addEventListener('click', moveDown);
      document.getElementById('left').addEventListener('click', moveLeft);
      document.getElementById('right').addEventListener('click', moveRight);

      const activePlayers = {};

      // Função para buscar a posição de outros jogadores periodicamente
      function fetchPlayersPositions() {
        const currentTime = new Date();
        supabase
          .from('game_state')
          .select('*')
          .then(({ data, error }) => {
            if (error) {
              console.error("Erro ao buscar jogadores:", error);
            } else {
              const currentPlayerIds = data.map(player => player.player_id);
              Object.keys(activePlayers).forEach(id => {
                if (!currentPlayerIds.includes(Number(id))) {
                  const inactivePlayer = document.getElementById(`player-${id}`);
                  if (inactivePlayer) {
                    inactivePlayer.remove();
                    delete activePlayers[id];
                  }
                }
              });

              let activePlayerCount = 0;

              data.forEach(player => {
                const lastUpdated = new Date(player.last_updated);
                const timeDiff = (currentTime - lastUpdated) / 1000;

                if (timeDiff < 10) { // Considera o jogador ativo se atualizado nos últimos 10 segundos
                  activePlayerCount++;
                  if (player.player_id !== playerId) {
                    let otherPlayer = activePlayers[player.player_id];
                    if (!otherPlayer) {
                      otherPlayer = document.createElement('div');
                      otherPlayer.id = `player-${player.player_id}`;
                      otherPlayer.className = 'player player-other';
                      document.getElementById('gameArea').appendChild(otherPlayer);
                      activePlayers[player.player_id] = otherPlayer;
                    }
                    otherPlayer.style.left = `${player.position_x}%`;
                    otherPlayer.style.top = `${player.position_y}%`;
                  }
                } else {
                  const inactivePlayer = document.getElementById(`player-${player.player_id}`);
                  if (inactivePlayer) {
                    inactivePlayer.remove();
                    delete activePlayers[player.player_id];
                  }
                }
              });

              // Limpa a tabela se não houver jogadores ativos além do jogador atual
              if (activePlayerCount <= 1) {
                clearInactivePlayers();
              }
            }
          });
      }

      // Função para limpar a tabela de jogadores inativos
      async function clearInactivePlayers() {
        const { error } = await supabase
          .from('game_state')
          .delete()
          .lt('last_updated', new Date(new Date() - 10 * 1000)); // Limpa entradas mais antigas que 10 segundos

        if (error) {
          console.error("Erro ao limpar jogadores inativos:", error);
        } else {
          console.log("Jogadores inativos limpos.");
        }
      }

      // Chama a função a cada 1 segundo para atualizar as posições dos jogadores
      setInterval(fetchPlayersPositions, 1000);
    });
  </script>
</body>
</html>