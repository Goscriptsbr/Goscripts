<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Rescisão Trabalhista</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #eef2f7;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 600;
    }
    form {
      max-width: 700px;
      margin: auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
      color: #34495e;
    }
    input, select {
      width: calc(100% - 20px);
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #c8d1da;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    button {
      margin-top: 25px;
      width: 100%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 17px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    #resultado {
      max-width: 700px;
      margin: 30px auto 0;
      background-color: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
      font-size: 16px;
      line-height: 1.6;
      color: #2c3e50;
    }
    .resultado-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed #ebf0f5;
    }
    .resultado-item:last-child {
      border-bottom: none;
    }
    .resultado-label {
      font-weight: bold;
      color: #34495e;
    }
    .resultado-value {
      text-align: right;
      color: #007bff;
      font-weight: 500;
    }
    .resultado-total {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #007bff;
      font-size: 1.2em;
      font-weight: bold;
      color: #0056b3;
      display: flex;
      justify-content: space-between;
    }
    .section-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #2c3e50;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 1px solid #c8d1da;
      padding-bottom: 5px;
    }
    .time-inputs {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    .time-inputs > div {
        flex: 1;
    }
    .total-descontos {
      color: #dc3545; /* Cor vermelha para descontos */
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ebf0f5;
      display: flex;
      justify-content: space-between;
    }
    small {
        font-size: 0.85em;
        color: #777;
        margin-top: 5px;
        display: block;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Rescisão Trabalhista</h1>

  <form id="formRescisao">
    <label for="nome">Nome do Colaborador</label>
    <input type="text" id="nome" required />

    <label for="cpf">CPF</label>
    <input type="text" id="cpf" required placeholder="Ex: 123.456.789-00"/>

    <label for="salario">Salário Bruto Mensal (R$)</label>
    <input type="number" id="salario" required min="0" step="0.01" />
    <small>Informe o salário mensal habitual, já incluindo médias de horas extras e adicional noturno. Este valor será a base para o cálculo de verbas e descontos.</small>

    <label for="dataAdmissao">Data de Admissão</label>
    <input type="date" id="dataAdmissao" required />

    <label for="dataDemissao">Data de Demissão</label>
    <input type="date" id="dataDemissao" required />

    <label for="tipoRescisao">Tipo de Rescisão</label>
    <select id="tipoRescisao">
      <option value="semJusta">Sem Justa Causa</option>
      <option value="pedido">Pedido de Demissão</option>
      <option value="comJusta">Com Justa Causa</option>
      <option value="acordo">Acordo entre as partes</option>
    </select>

    <label for="feriasVencidas">Tem férias vencidas?</label>
    <select id="feriasVencidas">
      <option value="nao" selected>Não</option>
      <option value="sim">Sim</option>
    </select>

    <div id="mesesFeriasVencidasContainer" style="display: none;">
      <label for="mesesFeriasVencidas">Quantos períodos (12 meses) de férias vencidas? (Ex: 1)</label>
      <input type="number" id="mesesFeriasVencidas" min="0" value="0" />
    </div>

    <label for="avisoPrevio">Vai cumprir aviso prévio?</label>
    <select id="avisoPrevio">
      <option value="nao" selected>Não</option>
      <option value="sim">Sim</option>
    </select>
    <small>Se a rescisão for "Sem Justa Causa" ou "Acordo" e o aviso não for cumprido, ele será indenizado e acrescido ao cálculo.</small>


    <label for="saldoFgts">Saldo Atual do FGTS (R$)</label>
    <input type="number" id="saldoFgts" required min="0" step="0.01" value="0" />
    <small>Este valor será a base para o cálculo da multa de 40% ou 20% do FGTS, dependendo do tipo de rescisão. Verbas de FGTS e sua multa são indenizatórias e não geram desconto de INSS ou IRRF.</small>

    <label for="tipoJornada">Tipo de Jornada de Trabalho</label>
    <select id="tipoJornada">
        <option value="padrao">Jornada Padrão (Ex: 8h/dia)</option>
        <option value="12x36">Escala 12x36</option>
        <option value="alternada">Um dia sim, um dia não</option>
    </select>
    <small>Para o cálculo estimado de horas noturnas e diárias.</small>

    <div id="jornadaPadraoInputs">
        <label>Horários da Jornada (Padrão)</label>
        <div class="time-inputs">
            <div>
                <label for="inicioJornada">Entrada</label>
                <input type="time" id="inicioJornada" required />
            </div>
            <div>
                <label for="fimJornada">Saída</label>
                <input type="time" id="fimJornada" required />
            </div>
        </div>
        <label>Horários de Almoço</label>
        <div class="time-inputs">
            <div>
                <label for="inicioAlmoco">Início</label>
                <input type="time" id="inicioAlmoco" required />
            </div>
            <div>
                <label for="fimAlmoco">Fim</label>
                <input type="time" id="fimAlmoco" required />
            </div>
        </div>
    </div>
    
    <div class="section-title" style="margin-top: 30px;">Benefícios e Outros Descontos</div>

    <label for="valorMensalVT">Valor Mensal do Vale-Transporte (R$)</label>
    <input type="number" id="valorMensalVT" min="0" step="0.01" value="0" />
    <small>Informe o valor total do VT que a empresa pagaria mensalmente. O sistema calculará o desconto proporcional (limitado a 6% do salário proporcional).</small>

    <label for="valorMensalVA">Valor Mensal do Vale-Alimentação/Refeição (R$)</label>
    <input type="number" id="valorMensalVA" min="0" step="0.01" value="0" />
    <small>Informe o valor total do VA/VR que a empresa pagaria mensalmente. O sistema calculará o desconto proporcional aos dias úteis.</small>

    <label for="outrosDescontos">Outros Descontos (Adiantamentos, Empréstimos, etc.) (R$)</label>
    <input type="number" id="outrosDescontos" min="0" step="0.01" value="0" />
    <small>Valores que devem ser descontados do colaborador.</small>
    
    <button type="submit">Calcular Rescisão</button>
    <button type="button" onclick="gerarPDF()">Gerar PDF</button>
  </form>

  <div id="resultado"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const feriasVencidasSelect = document.getElementById('feriasVencidas');
      const mesesFeriasVencidasContainer = document.getElementById('mesesFeriasVencidasContainer');
      const tipoJornadaSelect = document.getElementById('tipoJornada');
      const jornadaPadraoInputs = document.getElementById('jornadaPadraoInputs');
      const inicioJornadaInput = document.getElementById('inicioJornada');
      const fimJornadaInput = document.getElementById('fimJornada');
      const inicioAlmocoInput = document.getElementById('inicioAlmoco');
      const fimAlmocoInput = document.getElementById('fimAlmoco');


      feriasVencidasSelect.addEventListener('change', () => {
        if (feriasVencidasSelect.value === 'sim') {
          mesesFeriasVencidasContainer.style.display = 'block';
        } else {
          mesesFeriasVencidasContainer.style.display = 'none';
          document.getElementById('mesesFeriasVencidas').value = 0;
        }
      });

      tipoJornadaSelect.addEventListener('change', () => {
          if (tipoJornadaSelect.value === 'padrao') {
              jornadaPadraoInputs.style.display = 'block';
              inicioJornadaInput.setAttribute('required', 'required');
              fimJornadaInput.setAttribute('required', 'required');
              inicioAlmocoInput.setAttribute('required', 'required');
              fimAlmocoInput.setAttribute('required', 'required');
          } else {
              jornadaPadraoInputs.style.display = 'none';
              inicioJornadaInput.removeAttribute('required');
              fimJornadaInput.removeAttribute('required');
              inicioAlmocoInput.removeAttribute('required');
              fimAlmocoInput.removeAttribute('required');
          }
      });
      tipoJornadaSelect.dispatchEvent(new Event('change')); // Trigger initial display state
    });

    function diferencaHoras(inicio, fim) {
      const [hi, mi] = inicio.split(':').map(Number);
      const [hf, mf] = fim.split(':').map(Number);
      let minutosInicio = hi * 60 + mi;
      let minutosFim = hf * 60 + mf;
      if (minutosFim < minutosInicio) minutosFim += 24 * 60; // Lida com jornada que vira o dia
      return (minutosFim - minutosInicio) / 60;
    }

    function calcularHorasNoturnas(inicio, fim) {
      const [hi, mi] = inicio.split(':').map(Number);
      const [hf, mf] = fim.split(':').map(Number);
      let inicioMin = hi * 60 + mi;
      let fimMin = hf * 60 + mf;
      if (fimMin < inicioMin) fimMin += 24 * 60; // Lida com jornada que vira o dia

      let totalNoturno = 0;
      // Período noturno CLT: 22:00 às 05:00
      const noturnoInicio1 = 22 * 60; 
      const noturnoFim1 = 24 * 60;   
      const noturnoInicio2 = 0 * 60;   
      const noturnoFim2 = 5 * 60;    

      function intersecao(aStart, aEnd, bStart, bEnd) {
        const start = Math.max(aStart, bStart);
        const end = Math.min(aEnd, bEnd);
        return Math.max(0, end - start);
      }

      // Interseção com o período noturno do dia de início
      totalNoturno += intersecao(inicioMin, Math.min(fimMin, 24 * 60), noturnoInicio1, noturnoFim1);
      totalNoturno += intersecao(inicioMin, Math.min(fimMin, 24 * 60), noturnoInicio2, noturnoFim2);

      // Se a jornada passar para o dia seguinte, calcula a interseção com o período noturno do dia seguinte
      if (fimMin > 24 * 60) {
        totalNoturno += intersecao(0, fimMin - 24 * 60, noturnoInicio2, noturnoFim2);
      }
      return totalNoturno / 60; // Retorna em horas
    }

    function calcularMesesFeriasProporcionais(admissao, demissao) {
      // Esta função é usada para FÉRIAS PROPORCIONAIS (período aquisitivo)
      // Ela calcula os meses inteiros de contrato + o último mês se trabalhado >= 15 dias
      let meses = 0;
      
      // Calculate full months
      meses = (demissao.getUTCFullYear() - admissao.getUTCFullYear()) * 12;
      meses += (demissao.getUTCMonth() - admissao.getUTCMonth());
      
      // Check if the last month counts as an avo (15 days or more worked)
      // If demission date is 15th or later of the month, that month counts
      // If admission date is 15th or earlier, that month counts
      if (demissao.getUTCDate() >= 15 && demissao.getUTCMonth() !== admissao.getUTCMonth() || 
          (demissao.getUTCMonth() === admissao.getUTCMonth() && (demissao.getUTCDate() - admissao.getUTCDate() + 1) >= 15)) {
          meses++;
      }
      // Special case: if admission and demission are in the same month and less than 15 days, it shouldn't count.
      if (meses > 0 && demissao.getUTCMonth() === admissao.getUTCMonth() && demissao.getUTCFullYear() === admissao.getUTCFullYear() && (demissao.getUTCDate() - admissao.getUTCDate() + 1) < 15) {
          meses = 0; // If less than 15 days in the same month, no avo for proportional
      }

      return Math.max(0, meses); // Ensure it's not negative
    }


    function calcularAvosDecimoTerceiro(admissao, demissao) {
        let avos = 0;
        const anoDemissao = demissao.getUTCFullYear();
        
        let mesInicioContagem = (admissao.getUTCFullYear() === anoDemissao) ? admissao.getUTCMonth() : 0; // Janeiro ou mês da admissão
        
        for (let mes = mesInicioContagem; mes <= demissao.getUTCMonth(); mes++) {
            let inicioDoMes = new Date(anoDemissao, mes, 1);
            let fimDoMes = new Date(anoDemissao, mes + 1, 0); // Último dia do mês
            let diasTrabalhadosNoMes = 0;

            if (mes === admissao.getUTCMonth() && anoDemissao === admissao.getUTCFullYear()) {
                // Se é o mês de admissão no ano de demissão
                diasTrabalhadosNoMes = Math.min(demissao.getUTCDate(), fimDoMes.getUTCDate()) - admissao.getUTCDate() + 1;
            } else if (mes === demissao.getUTCMonth()) {
                // Se é o mês de demissão (e não é o mesmo mês da admissão)
                diasTrabalhadosNoMes = demissao.getUTCDate();
            } else {
                // Para meses completos entre a admissão e demissão no mesmo ano
                diasTrabalhadosNoMes = fimDoMes.getUTCDate();
            }
            
            if (diasTrabalhadosNoMes >= 15) {
                avos++;
            }
        }
        return Math.max(0, avos);
    }

    function calcularAvisoPrevioIndenizado(admissao, demissao, salarioBaseCalculo) {
      const diffTime = Math.abs(demissao.getTime() - admissao.getTime()); // getTime() para milissegundos
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Total de dias de contrato
      const anosTrabalhados = Math.floor(diffDays / 365.25); // Considera anos bissextos
      
      let diasAviso = 30; // 30 dias iniciais
      // A cada ano completo de serviço, somam-se 3 dias ao aviso prévio, limitado a 60 dias adicionais.
      if (anosTrabalhados > 0) {
        diasAviso += Math.min(60, anosTrabalhados * 3); 
      }
      return (salarioBaseCalculo / 30) * diasAviso;
    }

    function calcularINSS(baseCalculo) {
        let inss = 0;
        // Tabela INSS 2024 (usada para 2025 até nova portaria)
        // Faixas e alíquotas progressivas
        const faixas = [
            { limite: 1412.00, aliquota: 0.075, deducao: 0.00 },
            { limite: 2666.44, aliquota: 0.09, deducao: 105.90 }, 
            { limite: 4000.03, aliquota: 0.12, deducao: 193.30 }, 
            { limite: 7786.02, aliquota: 0.14, deducao: 333.30 } 
        ];

        if (baseCalculo <= 0) return 0;

        for (let i = 0; i < faixas.length; i++) {
            const faixa = faixas[i];
            
            if (baseCalculo <= faixa.limite) {
                inss = (baseCalculo * faixa.aliquota) - faixa.deducao;
                break;
            }
            // Se a base de cálculo for maior que o teto da última faixa, usa o teto
            if (i === faixas.length - 1 && baseCalculo > faixa.limite) {
                inss = (faixas[0].limite * faixas[0].aliquota) +
                       ((faixas[1].limite - faixas[0].limite) * faixas[1].aliquota) +
                       ((faixas[2].limite - faixas[1].limite) * faixas[2].aliquota) +
                       ((faixas[3].limite - faixas[2].limite) * faixas[3].aliquota);
                break;
            }
        }
        return Math.max(0, inss);
    }

    function calcularIRRF(baseCalculoIRRF, inssDescontado) {
        let irrf = 0;
        let baseLiquida = baseCalculoIRRF - inssDescontado;

        // Tabela IRRF 2024 (usada para 2025 até nova portaria)
        const faixasIRRF = [
            { limite: 2259.20, aliquota: 0.00, deducao: 0.00 },
            { limite: 2826.65, aliquota: 0.075, deducao: 169.44 },
            { limite: 3751.05, aliquota: 0.15, deducao: 381.44 },
            { limite: 4664.68, aliquota: 0.225, deducao: 662.77 },
            { limite: Infinity, aliquota: 0.275, deducao: 896.00 }
        ];

        if (baseLiquida <= 0) return 0;

        for (let i = 0; i < faixasIRRF.length; i++) {
            const faixa = faixasIRRF[i];
            if (baseLiquida <= faixa.limite) {
                irrf = (baseLiquida * faixa.aliquota) - faixa.deducao;
                break;
            }
        }
        return Math.max(0, irrf);
    }

    document.getElementById('formRescisao').addEventListener('submit', function (event) {
      event.preventDefault();

      const nome = document.getElementById('nome').value;
      const cpf = document.getElementById('cpf').value;
      const salarioBase = parseFloat(document.getElementById('salario').value); 
      
      // Garante que as datas sejam tratadas como UTC para evitar problemas de fuso horário
      const admissao = new Date(document.getElementById('dataAdmissao').value + 'T00:00:00Z'); 
      const demissao = new Date(document.getElementById('dataDemissao').value + 'T00:00:00Z'); 
      const tipoRescisao = document.getElementById('tipoRescisao').value;
      const feriasVencidasSimNao = document.getElementById('feriasVencidas').value;
      const mesesFeriasVencidas = parseInt(document.getElementById('mesesFeriasVencidas').value) || 0;
      const avisoPrevioCumprido = document.getElementById('avisoPrevio').value === 'sim';
      const saldoFgts = parseFloat(document.getElementById('saldoFgts').value); 
      const tipoJornada = document.getElementById('tipoJornada').value;

      const valorMensalVT = parseFloat(document.getElementById('valorMensalVT').value) || 0;
      const valorMensalVA = parseFloat(document.getElementById('valorMensalVA').value) || 0;
      const outrosDescontos = parseFloat(document.getElementById('outrosDescontos').value) || 0;


      let totalHorasTrabalhadasDia = 0;
      let horasNoturnasDia = 0;

      if (tipoJornada === 'padrao') {
          const inicioJornada = document.getElementById('inicioJornada').value;
          const fimJornada = document.getElementById('fimJornada').value;
          const inicioAlmoco = document.getElementById('inicioAlmoco').value;
          const fimAlmoco = document.getElementById('fimAlmoco').value;
          totalHorasTrabalhadasDia = diferencaHoras(inicioJornada, fimJornada) - diferencaHoras(inicioAlmoco, fimAlmoco);
          horasNoturnasDia = calcularHorasNoturnas(inicioJornada, fimJornada);
      } else if (tipoJornada === '12x36') {
          totalHorasTrabalhadasDia = 12; 
          horasNoturnasDia = 7; // Aproximadamente 7h noturnas em 12h de trabalho (22h às 5h)
      } else if (tipoJornada === 'alternada') { 
          totalHorasTrabalhadasDia = 8; 
          horasNoturnasDia = 0; // Presumindo jornada diurna para simplificação.
      }

      const remuneracaoParaVerbas = salarioBase; 

      // Saldo de Salário
      const diasNoMesDemissao = new Date(demissao.getUTCFullYear(), demissao.getUTCMonth() + 1, 0).getUTCDate(); 
      const diaDemissao = demissao.getUTCDate(); 
      const saldoSalario = (remuneracaoParaVerbas / diasNoMesDemissao) * diaDemissao; 

      // 13º Salário Proporcional
      const avosDecimoTerceiro = calcularAvosDecimoTerceiro(admissao, demissao);
      const decimoTerceiroProporcional = (remuneracaoParaVerbas / 12) * avosDecimoTerceiro;

      // Férias Proporcionais + 1/3
      const mesesFeriasProporcionais = calcularMesesFeriasProporcionais(admissao, demissao);
      const feriasProporcionais = (remuneracaoParaVerbas / 12) * mesesFeriasProporcionais;
      const adicional1TercoFeriasProporcionais = feriasProporcionais / 3;

      // Férias Vencidas + 1/3
      let valorFeriasVencidas = 0;
      let mesesFeriasVencidasDisplay = 'Não';
      if (feriasVencidasSimNao === 'sim' && mesesFeriasVencidas > 0) {
        valorFeriasVencidas = (remuneracaoParaVerbas + (remuneracaoParaVerbas / 3)) * mesesFeriasVencidas; 
        mesesFeriasVencidasDisplay = `${mesesFeriasVencidas} período(s)`;
      }

      // Aviso Prévio Indenizado
      let avisoPrevioIndenizado = 0;
      if (!avisoPrevioCumprido && (tipoRescisao === 'semJusta' || tipoRescisao === 'acordo')) {
        avisoPrevioIndenizado = calcularAvisoPrevioIndenizado(admissao, demissao, remuneracaoParaVerbas);
      }

      // Multa FGTS (baseada no saldo informado)
      let multaFGTS = 0;
      if (tipoRescisao === 'semJusta') {
        multaFGTS = saldoFgts * 0.4; // 40% do saldo do FGTS
      } else if (tipoRescisao === 'acordo') {
        multaFGTS = saldoFgts * 0.2; // 20% do saldo do FGTS
      }

      // --- Cálculo de Verbas de INCIDÊNCIA (INSS e IRRF) ---
      
      // Base de cálculo do INSS (incide sobre Saldo de Salário e 13º Salário Proporcional)
      const baseINSS = saldoSalario + decimoTerceiroProporcional;
      const valorINSS = calcularINSS(baseINSS);

      // 1. IRRF sobre o 13º Salário (tributação exclusiva na fonte)
      const baseIRRF13 = decimoTerceiroProporcional;
      const inss13Proporcional = calcularINSS(baseIRRF13); // Calcula o INSS apenas sobre o 13º para fins de dedução
      const valorIRRF13 = calcularIRRF(baseIRRF13, inss13Proporcional);

      // 2. IRRF sobre Saldo de Salário e Aviso Prévio Indenizado
      const baseIRRFDemaisVerbas = saldoSalario + avisoPrevioIndenizado;
      // Para fins de IRRF sobre demais verbas, o INSS dedutível é o INSS sobre o saldo de salário.
      const inssSobreSaldoSalarioParaIRRF = calcularINSS(saldoSalario); 
      const valorIRRFPrincipal = calcularIRRF(baseIRRFDemaisVerbas, inssSobreSaldoSalarioParaIRRF); 
      
      const valorIRRFTotal = valorIRRFPrincipal + valorIRRF13;


      // --- Cálculo dos Descontos de VT e VA/VR proporcionais ---
      
      // Calcular dias úteis totais do mês da demissão (movido para aqui para ser acessível)
      let diasUteisNoMes = 0;
      const primeiroDiaMesDemissaoCalc = new Date(demissao.getUTCFullYear(), demissao.getUTCMonth(), 1);
      const ultimoDiaMesDemissaoCalc = new Date(demissao.getUTCFullYear(), demissao.getUTCMonth() + 1, 0);

      for (let d = primeiroDiaMesDemissaoCalc; d <= ultimoDiaMesDemissaoCalc; d.setUTCDate(d.getUTCDate() + 1)) {
          const dayOfWeek = d.getUTCDay(); // 0 = Domingo, 6 = Sábado
          if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Se não for sábado nem domingo
              diasUteisNoMes++;
          }
      }

      // Desconto de VT
      let descontoVTCalculado = 0;
      if (valorMensalVT > 0) {
        // Desconto de VT é limitado a 6% do salário proporcional do mês da rescisão
        const limite6Porcento = (saldoSalario * 0.06);
        descontoVTCalculado = Math.min(valorMensalVT, limite6Porcento);
      }

      // Desconto de VA/VR
      let descontoVACalculado = 0;
      if (valorMensalVA > 0) {
        let diasUteisRestantes = 0;
        // Percorre do dia seguinte à demissão até o final do mês para contar dias úteis não trabalhados
        for (let d = new Date(demissao.getUTCFullYear(), demissao.getUTCMonth(), demissao.getUTCDate() + 1); 
             d <= new Date(demissao.getUTCFullYear(), demissao.getUTCMonth() + 1, 0); 
             d.setUTCDate(d.getUTCDate() + 1)) {
            const dayOfWeek = d.getUTCDay(); // 0 = Domingo, 6 = Sábado
            if (dayOfWeek !== 0 && dayOfWeek !== 6) { 
                diasUteisRestantes++;
            }
        }
        // Calcula o valor diário do VA com base nos dias úteis TOTAIS do mês
        // E multiplica pelos dias úteis *não trabalhados* (restantes)
        const valorDiarioVA = valorMensalVA / diasUteisNoMes; 
        descontoVACalculado = valorDiarioVA * diasUteisRestantes;
        descontoVACalculado = Math.max(0, descontoVACalculado);
      }


      // --- Cálculo do Total Geral e Total Líquido ---
      let totalVerbasReceber = saldoSalario + decimoTerceiroProporcional + feriasProporcionais + adicional1TercoFeriasProporcionais + valorFeriasVencidas;
      
      if (tipoRescisao === 'semJusta' || tipoRescisao === 'acordo') {
        totalVerbasReceber += multaFGTS; 
        if (!avisoPrevioCumprido) { 
            totalVerbasReceber += avisoPrevioIndenizado;
        }
      }

      const totalDescontos = valorINSS + valorIRRFTotal + descontoVTCalculado + descontoVACalculado + outrosDescontos; 
      const totalLiquido = totalVerbasReceber - totalDescontos;


      // Display results
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.innerHTML = `
        <div class="section-title">Dados do Colaborador</div>
        <div class="resultado-item">
          <span class="resultado-label">Nome:</span>
          <span class="resultado-value">${nome}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">CPF:</span>
          <span class="resultado-value">${cpf}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Salário Bruto Mensal:</span>
          <span class="resultado-value">R$ ${salarioBase.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Data de Admissão:</span>
          <span class="resultado-value">${admissao.toLocaleDateString('pt-BR')}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Data de Demissão:</span>
          <span class="resultado-value">${demissao.toLocaleDateString('pt-BR')}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Tipo de Rescisão:</span>
          <span class="resultado-value">${document.getElementById('tipoRescisao').selectedOptions[0].text}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Saldo do FGTS Informado (base para multa):</span>
          <span class="resultado-value">R$ ${saldoFgts.toFixed(2)}</span>
        </div>

        <div class="section-title">Verbas Rescisórias (Proventos)</div>
        <div class="resultado-item">
          <span class="resultado-label">Saldo de Salário:</span>
          <span class="resultado-value">R$ ${saldoSalario.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">13º Salário Proporcional (${avosDecimoTerceiro}/12 avos):</span>
          <span class="resultado-value">R$ ${decimoTerceiroProporcional.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Férias Proporcionais (${mesesFeriasProporcionais}/12 avos):</span>
          <span class="resultado-value">R$ ${feriasProporcionais.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Adicional de 1/3 Férias Proporcionais:</span>
          <span class="resultado-value">R$ ${adicional1TercoFeriasProporcionais.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Férias Vencidas ${mesesFeriasVencidasDisplay !== 'Não' ? `(${mesesFeriasVencidasDisplay})` : ''}:</span>
          <span class="resultado-value">R$ ${valorFeriasVencidas.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Aviso Prévio Indenizado:</span>
          <span class="resultado-value">R$ ${avisoPrevioIndenizado.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Multa FGTS (40% ou 20%):</span>
          <span class="resultado-value">R$ ${multaFGTS.toFixed(2)}</span>
        </div>

        <div class="section-title">Descontos</div>
        <div class="resultado-item">
          <span class="resultado-label">Desconto INSS:</span>
          <span class="resultado-value">R$ ${valorINSS.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Desconto IRRF (Outras Verbas):</span>
          <span class="resultado-value">R$ ${valorIRRFPrincipal.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Desconto IRRF (13º Salário):</span>
          <span class="resultado-value">R$ ${valorIRRF13.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Desconto Vale-Transporte (proporcional):</span>
          <span class="resultado-value">R$ ${descontoVTCalculado.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Desconto Vale-Alimentação/Refeição (proporcional):</span>
          <span class="resultado-value">R$ ${descontoVACalculado.toFixed(2)}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Outros Descontos Informados:</span>
          <span class="resultado-value">R$ ${outrosDescontos.toFixed(2)}</span>
        </div>
        <div class="total-descontos">
          <span>Total de Descontos:</span>
          <span>R$ ${totalDescontos.toFixed(2)}</span>
        </div>


        <div class="section-title">Jornada de Trabalho (Estimativa)</div>
        <div class="resultado-item">
          <span class="resultado-label">Tipo de Jornada Selecionada:</span>
          <span class="resultado-value">${document.getElementById('tipoJornada').selectedOptions[0].text}</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Horas Trabalhadas por Dia (estimado):</span>
          <span class="resultado-value">${totalHorasTrabalhadasDia.toFixed(2)}h</span>
        </div>
        <div class="resultado-item">
          <span class="resultado-label">Horas Noturnas por Dia (estimado):</span>
          <span class="resultado-value">${horasNoturnasDia.toFixed(2)}h</span>
        </div>

        <div class="resultado-total">
          <span>Total Líquido a Receber (pagamento da empresa):</span>
          <span>R$ ${totalLiquido.toFixed(2)}</span>
        </div>
        <p style="font-size: 0.9em; color: #666; text-align: center; margin-top: 20px;">
          **Atenção:** Esta calculadora simula verbas rescisórias e descontos com base nas tabelas atuais do INSS e IRRF (reajustadas anualmente), e princípios gerais da CLT.
          <ul>
            <li>O INSS é calculado sobre as verbas salariais (como saldo de salário e 13º proporcional), mesmo que o período trabalhado no mês seja curto.</li>
            <li>O IRRF é calculado sobre as verbas tributáveis (saldo de salário, 13º proporcional e aviso prévio indenizado), e só há desconto se o valor ultrapassar a faixa de isenção mensal.</li>
            <li>O <b>Salário Bruto Mensal</b> deve ser informado já com as médias de horas extras e adicional noturno habituais.</li>
            <li>Os valores mensais de VT e VA/VR devem ser informados para que o sistema estime os descontos proporcionais.</li>
          </ul>
          Ela não substitui um cálculo oficial, que pode incluir deduções por dependentes, pensão alimentícia, e particularidades de Convenções Coletivas. Para um cálculo oficial e completo, consulte um profissional de RH, contador ou advogado trabalhista.
        </p>
      `;
    });

    function gerarPDF() {
      const resultadoDiv = document.getElementById('resultado');
      if (!resultadoDiv.textContent) {
        alert("Calcule a rescisão antes de gerar o PDF.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const content = resultadoDiv.innerHTML;

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = content;
      const lines = tempDiv.textContent.split('\n').filter(line => line.trim() !== '');

      let y = 15;
      const margin = 10;
      doc.setFontSize(12);

      doc.text("Relatório de Rescisão Trabalhista", margin, y);
      y += 10;
      doc.line(margin, y, 200, y);
      y += 10;

      lines.forEach(line => {
        if (line.includes('Dados do Colaborador') || line.includes('Verbas Rescisórias (Proventos)') || line.includes('Descontos') || line.includes('Jornada de Trabalho')) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(line.trim(), margin, y);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            y += 8;
        } else if (line.includes('Total Líquido a Receber')) {
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 90, 179);
            doc.text(line.trim(), margin, y);
            doc.setTextColor(0, 0, 0);
            y += 8;
        } else if (line.includes('Total de Descontos')) {
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(220, 53, 69);
            doc.text(line.trim(), margin, y);
            doc.setTextColor(0, 0, 0);
            y += 7;
        }
        else {
            const parts = line.split(':');
            if (parts.length > 1) {
                doc.text(parts[0].trim() + ':', margin, y);
                doc.text(parts[1].trim(), 150, y, { align: 'right' });
            } else {
                doc.text(line.trim(), margin, y);
            }
        }
        y += 7;

        if (y > 280) {
          doc.addPage();
          y = 15;
        }
      });
      doc.setFontSize(8);
      doc.setFont(undefined, 'italic');
      doc.text("Atenção: Esta calculadora simula verbas rescisórias e descontos com base nas tabelas atuais do INSS e IRRF (reajustadas anualmente), e princípios gerais da CLT. O Salário Bruto Mensal deve ser informado já com as médias de horas extras e adicional noturno habituais. Os valores mensais de VT e VA/VR devem ser informados para que o sistema estime os descontos proporcionais. Ela não substitui um cálculo oficial, que pode incluir deduções por dependentes, pensão alimentícia, e particularidades de Convenções Coletivas. Para um cálculo oficial e completo, consulte um profissional de RH, contador ou advogado trabalhista.", margin, y + 10, { maxWidth: 190, align: 'justify' });

      doc.save('rescisao.pdf');
    }
  </script>
</body>
</html>
